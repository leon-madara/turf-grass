class S{constructor(){this.coupons=[],this.loadCoupons()}async loadCoupons(){try{const n=await(await fetch("/Eastleigh-Turf-Grass-Clean/data/coupons.json")).json();this.coupons=n.coupons||[]}catch(o){console.error("Error loading coupons:",o),this.coupons=[]}}validateCoupon(o,n=0){const t=this.coupons.find(p=>p.code.toUpperCase()===o.toUpperCase());if(!t)return{valid:!1,message:"Invalid coupon code"};const s=new Date,a=new Date(t.validFrom),u=new Date(t.validTo);return s<a||s>u?{valid:!1,message:"Coupon has expired or is not yet valid"}:n<t.minOrder?{valid:!1,message:`Minimum order of KES ${t.minOrder.toLocaleString()} required`}:t.usedCount>=t.usageLimit?{valid:!1,message:"Coupon usage limit reached"}:{valid:!0,coupon:t,message:"Coupon applied successfully"}}calculateCouponDiscount(o,n){let t=0;return o.type==="percentage"?t=n*(o.value/100):o.type==="fixed"&&(t=o.value),t>o.maxDiscount&&(t=o.maxDiscount),Math.min(t,n)}applyCoupon(o,n){const t=this.validateCoupon(o,n);if(!t.valid)return t;const s=t.coupon,a=this.calculateCouponDiscount(s,n),u=n-a;return{valid:!0,coupon:s,discountAmount:a,finalTotal:u,message:`Coupon "${s.code}" applied! You saved KES ${a.toLocaleString()}`}}getAvailableCoupons(o=0){return this.coupons.filter(n=>this.validateCoupon(n.code,o).valid)}incrementCouponUsage(o){const n=this.coupons.find(t=>t.code.toUpperCase()===o.toUpperCase());n&&n.usedCount++}}const v=new S;class T{constructor(){this.promotions=[],this.loadPromotions()}async loadPromotions(){try{const n=await(await fetch("/Eastleigh-Turf-Grass-Clean/data/discounts.json")).json();this.promotions=n.promotions||[]}catch(o){console.error("Error loading promotions:",o),this.promotions=[]}}getAvailablePromotions(o=0){const n=new Date;return this.promotions.filter(t=>{if(!t.active)return!1;const s=new Date(t.validFrom),a=new Date(t.validTo);return!(n<s||n>a||o<t.minOrder)})}getBestPromotion(o=0){const n=this.getAvailablePromotions(o);return n.length===0?null:n.map(s=>{const a=this.calculatePromotionDiscount(s,o);return{...s,potentialSavings:a}}).reduce((s,a)=>a.potentialSavings>s.potentialSavings?a:s)}calculatePromotionDiscount(o,n){let t=0;return o.type==="percentage"?t=n*(o.value/100):o.type==="fixed"&&(t=o.value),t>o.maxDiscount&&(t=o.maxDiscount),Math.min(t,n)}applyPromotion(o,n){const t=this.promotions.find(r=>r.id===o);if(!t)return{valid:!1,message:"Promotion not found"};if(!this.getAvailablePromotions(n).some(r=>r.id===o))return{valid:!1,message:"Promotion not available for this order"};const u=this.calculatePromotionDiscount(t,n),p=n-u;return{valid:!0,promotion:t,discountAmount:u,finalTotal:p,message:`${t.name} applied! You saved KES ${u.toLocaleString()}`}}getPromotionDetails(o){return this.promotions.find(n=>n.id===o)}hasAvailablePromotions(o=0){return this.getAvailablePromotions(o).length>0}getPromotionSummary(o=0){const n=this.getBestPromotion(o);if(!n)return null;const t=this.calculatePromotionDiscount(n,o);return{promotion:n,savings:t,finalTotal:o-t,savingsPercentage:(t/o*100).toFixed(1)}}}const m=new T,x=(()=>{let c=[],o=null,n=null,t=[];function s(){return[...c]}function a(e){const i=Date.now();c.push({id:i,...e}),d()}function u(e){c=c.filter(i=>i.id!==e),d()}function p(){c=[],o=null,n=null,d()}function r(){return c.reduce((e,i)=>e+i.total,0)}function h(e){const i=r(),l=v.applyCoupon(e,i);return l.valid&&(o=l.coupon,n=null,v.incrementCouponUsage(e)),d(),l}function C(e){const i=r(),l=m.applyPromotion(e,i);return l.valid&&(n=l.promotion,o=null),d(),l}function P(){o=null,n=null,d()}function f(){const e=r();let i=0;return o?i=v.calculateCouponDiscount(o,e):n&&(i=m.calculatePromotionDiscount(n,e)),i}function g(){const e=r(),i=f();return e-i}function D(){const e=r();return m.getAvailablePromotions(e)}function A(){const e=r();return m.getBestPromotion(e)}function d(){const e=r(),i=f(),l=g();t.forEach(b=>{try{b({items:s(),subtotal:e,discountAmount:i,total:l,appliedCoupon:o,appliedPromotion:n})}catch(y){console.error("Cart subscriber error:",y)}}),window.renderCartUI&&window.renderCartUI(s(),l,i)}function w(e){return t.push(e),()=>{const i=t.indexOf(e);i>-1&&t.splice(i,1)}}return{getItems:s,add:a,remove:u,clear:p,getSubtotal:r,applyCoupon:h,applyPromotion:C,removeDiscount:P,getDiscountAmount:f,getTotal:g,getAvailablePromotions:D,getBestPromotion:A,subscribe:w}})();export{x as C};
