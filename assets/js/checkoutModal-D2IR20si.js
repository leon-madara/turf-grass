class L{constructor(){this.currentStep=1,this.totalSteps=3,this.customerData={name:"",phone:"",location:""},this.rememberDetails=!0,this.subscribers=[],this.loadSavedData()}loadSavedData(){try{const e=localStorage.getItem("checkout_customer_data");if(e){const t=JSON.parse(e);this.customerData={...this.customerData,...t}}}catch(e){console.warn("Failed to load saved checkout data:",e)}}saveCustomerData(){if(this.rememberDetails)try{localStorage.setItem("checkout_customer_data",JSON.stringify(this.customerData))}catch(e){console.warn("Failed to save checkout data:",e)}else localStorage.removeItem("checkout_customer_data")}updateCustomerData(e,t){this.customerData[e]=t,this.saveCustomerData(),this.notifySubscribers()}updateRememberDetails(e){this.rememberDetails=e,this.saveCustomerData(),this.notifySubscribers()}nextStep(){return this.currentStep<this.totalSteps?(this.currentStep++,this.notifySubscribers(),!0):!1}previousStep(){return this.currentStep>1?(this.currentStep--,this.notifySubscribers(),!0):!1}goToStep(e){return e>=1&&e<=this.totalSteps?(this.currentStep=e,this.notifySubscribers(),!0):!1}reset(){this.currentStep=1,this.notifySubscribers()}getState(){return{currentStep:this.currentStep,totalSteps:this.totalSteps,customerData:{...this.customerData},rememberDetails:this.rememberDetails}}subscribe(e){return this.subscribers.push(e),()=>{const t=this.subscribers.indexOf(e);t>-1&&this.subscribers.splice(t,1)}}notifySubscribers(){this.subscribers.forEach(e=>{try{e(this.getState())}catch(t){console.error("Error in checkout state subscriber:",t)}})}validateCurrentStep(){switch(this.currentStep){case 1:return this.validateCustomerDetails();case 2:return!0;case 3:return!0;default:return!1}}validateCustomerDetails(){const{name:e,phone:t,location:r}=this.customerData;return!e||e.trim().length<2?{valid:!1,field:"name",message:"Name must be at least 2 characters"}:!t||t.trim().length<9?{valid:!1,field:"phone",message:"Please enter a valid phone number"}:!r||r.trim().length<3?{valid:!1,field:"location",message:"Please enter your location"}:{valid:!0}}getCartData(){return window.CartComponent?{items:window.CartComponent.getItems(),total:window.CartComponent.getTotal(),count:window.CartComponent.getCount()}:{items:[],total:0,count:0}}getDiscountData(){return window.CartState?{subtotal:window.CartState.getSubtotal(),discountAmount:window.CartState.getDiscountAmount(),total:window.CartState.getTotal(),appliedCoupon:window.CartState.appliedCoupon,appliedPromotion:window.CartState.appliedPromotion}:{subtotal:0,discountAmount:0,total:0,appliedCoupon:null,appliedPromotion:null}}}const a=new L;class E{constructor(){this.phoneRegex=/^(\+254|0)?[17]\d{8}$/,this.emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/}validatePhone(e){if(!e)return{valid:!1,message:"Phone number is required"};const t=e.replace(/\s+/g,"");return this.phoneRegex.test(t)?{valid:!0,formatted:this.formatPhone(t)}:{valid:!1,message:"Please enter a valid Kenyan phone number"}}formatPhone(e){let t=e.replace(/\D/g,"");return t.startsWith("0")&&(t="254"+t.substring(1)),t.startsWith("+")||(t="+"+t),t}async detectPhone(){try{return"contacts"in navigator&&"select"in navigator.contacts?await this.detectPhoneFromContacts():"connection"in navigator?await this.detectPhoneFromSIM():await this.detectPhoneFromBrowser()}catch(e){return console.warn("Phone detection failed:",e),{success:!1,error:"Phone detection not available. Please enter manually.",type:"not_supported"}}}async detectPhoneFromContacts(){try{const e=await navigator.contacts.select(["tel"],{multiple:!1});if(e&&e.length>0){const t=e[0].tel[0];return{success:!0,phone:this.formatPhone(t),method:"contacts",message:"Phone number detected from contacts"}}return{success:!1,error:"No phone number selected from contacts",type:"no_selection"}}catch{return{success:!1,error:"Contact access denied or not available",type:"permission_denied"}}}async detectPhoneFromSIM(){try{return"connection"in navigator&&navigator.connection.effectiveType?{success:!1,error:"SIM detection not available in this browser",type:"not_supported"}:{success:!1,error:"SIM detection not supported",type:"not_supported"}}catch{return{success:!1,error:"SIM detection failed",type:"error"}}}async detectPhoneFromBrowser(){try{return navigator.userAgent.includes("Android")?{success:!1,error:"Please use the contact picker or enter manually",type:"android_fallback"}:navigator.userAgent.includes("iPhone")||navigator.userAgent.includes("iPad")?{success:!1,error:"Please use the contact picker or enter manually",type:"ios_fallback"}:{success:!1,error:"Phone detection not available in this browser",type:"browser_not_supported"}}catch{return{success:!1,error:"Browser detection failed",type:"error"}}}isPhoneDetectionSupported(){return"contacts"in navigator&&"select"in navigator.contacts||"connection"in navigator||navigator.userAgent.includes("Android")||navigator.userAgent.includes("iPhone")}validateName(e){if(!e)return{valid:!1,message:"Name is required"};const t=e.trim();return t.length<2?{valid:!1,message:"Name must be at least 2 characters"}:t.length>50?{valid:!1,message:"Name must be less than 50 characters"}:/^[a-zA-Z\s\-']+$/.test(t)?{valid:!0,formatted:this.formatName(t)}:{valid:!1,message:"Name contains invalid characters"}}formatName(e){return e.toLowerCase().replace(/\b\w/g,t=>t.toUpperCase())}validateLocation(e){if(!e)return{valid:!1,message:"Location is required"};const t=e.trim();return t.length<3?{valid:!1,message:"Location must be at least 3 characters"}:t.length>100?{valid:!1,message:"Location must be less than 100 characters"}:{valid:!0,formatted:this.formatLocation(t)}}formatLocation(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}validateEmail(e){return e?this.emailRegex.test(e)?{valid:!0,formatted:e.toLowerCase()}:{valid:!1,message:"Please enter a valid email address"}:{valid:!1,message:"Email is required"}}createDebouncedValidator(e,t=300){let r;return s=>(clearTimeout(r),new Promise(o=>{r=setTimeout(()=>{const n=e(s);o(n)},t)}))}showError(e,t){const r=e.closest(".form-group"),s=r.querySelector(".error-message");s&&s.remove(),e.classList.add("error");const o=document.createElement("div");o.className="error-message",o.textContent=t,r.appendChild(o)}clearError(e){const r=e.closest(".form-group").querySelector(".error-message");r&&r.remove(),e.classList.remove("error")}validateForm(e){const t={},r=this.validateName(e.name);r.valid||(t.name=r.message);const s=this.validatePhone(e.phone);s.valid||(t.phone=s.message);const o=this.validateLocation(e.location);return o.valid||(t.location=o.message),{valid:Object.keys(t).length===0,errors:t,formattedData:{name:r.formatted||e.name,phone:s.formatted||e.phone,location:o.formatted||e.location}}}setupAutoFormat(e,t){e.addEventListener("input",r=>{const s=t(r.target.value);s!==r.target.value&&(r.target.value=s)})}setupPhoneFormatting(e){e.addEventListener("input",t=>{let r=t.target.value.replace(/\D/g,"");r.length>9&&(r=r.substring(0,9)),r.length>0&&(r.startsWith("0")&&(r=r.substring(1)),r.length>=3&&(r=r.substring(0,3)+" "+r.substring(3)),r.length>=7&&(r=r.substring(0,7)+" "+r.substring(7))),t.target.value=r})}}const m=new E;class C{constructor(){this.isSupported="geolocation"in navigator,this.currentPosition=null}isGeolocationSupported(){return this.isSupported}async getCurrentLocation(){if(!this.isSupported)throw new Error("Geolocation is not supported in this browser");return new Promise((e,t)=>{const r={enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5};navigator.geolocation.getCurrentPosition(s=>{this.currentPosition=s,e(s)},s=>{t(this.handleGeolocationError(s))},r)})}handleGeolocationError(e){switch(e.code){case e.PERMISSION_DENIED:return{type:"permission_denied",message:"Location access was denied. Please enable location services.",code:"PERMISSION_DENIED"};case e.POSITION_UNAVAILABLE:return{type:"position_unavailable",message:"Location information is unavailable.",code:"POSITION_UNAVAILABLE"};case e.TIMEOUT:return{type:"timeout",message:"Location request timed out. Please try again.",code:"TIMEOUT"};default:return{type:"unknown",message:"An unknown error occurred while getting location.",code:"UNKNOWN_ERROR"}}}async getIPLocation(){try{const e=["https://ipapi.co/json/","https://ipinfo.io/json","https://api.ipify.org?format=json"];for(const t of e)try{const r=await fetch(t,{method:"GET",headers:{Accept:"application/json"},timeout:5e3});if(r.ok){const s=await r.json();return this.formatIPLocation(s)}}catch(r){console.warn(`IP location service ${t} failed:`,r);continue}throw new Error("All IP location services failed")}catch(e){throw console.error("IP location detection failed:",e),new Error("Could not detect location from IP address")}}formatIPLocation(e){return e.city&&e.country?{city:e.city,region:e.region,country:e.country,formatted:`${e.city}, ${e.region}, ${e.country}`,coordinates:e.loc?e.loc.split(",").map(Number):null}:e.city_name&&e.country_name?{city:e.city_name,region:e.region,country:e.country_name,formatted:`${e.city_name}, ${e.region}, ${e.country_name}`,coordinates:[e.latitude,e.longitude]}:{city:e.city||"Unknown",region:e.region||e.state||"Unknown",country:e.country||e.country_name||"Unknown",formatted:`${e.city||"Unknown"}, ${e.region||e.state||"Unknown"}, ${e.country||e.country_name||"Unknown"}`,coordinates:e.lat&&e.lon?[e.lat,e.lon]:null}}async reverseGeocode(e,t){try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}&zoom=18&addressdetails=1`);if(!r.ok)throw new Error("Failed to fetch location data");const s=await r.json();return this.formatAddress(s)}catch(r){throw console.error("Reverse geocoding failed:",r),new Error("Failed to get address from coordinates")}}formatAddress(e){if(!e.address)return"Unknown location";const t=e.address,r=[];return t.house_number&&t.road?r.push(`${t.house_number} ${t.road}`):t.road&&r.push(t.road),t.suburb&&r.push(t.suburb),t.city?r.push(t.city):t.town?r.push(t.town):t.village&&r.push(t.village),t.state&&r.push(t.state),t.country&&r.push(t.country),r.join(", ")}async detectLocation(){try{try{const e=await this.getCurrentLocation();return{success:!0,address:await this.reverseGeocode(e.coords.latitude,e.coords.longitude),method:"gps",coordinates:{latitude:e.coords.latitude,longitude:e.coords.longitude},accuracy:e.coords.accuracy,message:"Location detected using GPS"}}catch(e){console.warn("GPS detection failed, trying IP-based detection:",e);try{const t=await this.getIPLocation();return{success:!0,address:t.formatted,method:"ip",coordinates:t.coordinates,accuracy:"low",message:"Approximate location detected using IP address. Please verify your exact address.",isApproximate:!0}}catch(t){return console.warn("IP detection failed:",t),{success:!1,error:this.getHelpfulErrorMessage(e),type:e.type||"unknown",message:"Please enter your location manually"}}}}catch{return{success:!1,error:"Failed to detect location. Please enter manually.",type:"unknown"}}}getHelpfulErrorMessage(e){switch(e.type){case"permission_denied":return"Location access was denied. Please enable location services in your browser settings or enter your address manually.";case"timeout":return"Location detection timed out. Please try again or enter your address manually.";case"position_unavailable":return"Location information is currently unavailable. Please enter your address manually.";default:return"Could not detect your location automatically. Please enter your address manually."}}async searchLocations(e){if(!e||e.length<3)return[];try{const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}&countrycodes=ke&limit=5`);if(!t.ok)throw new Error("Failed to search locations");return(await t.json()).map(s=>({display_name:s.display_name,lat:s.lat,lon:s.lon,type:s.type}))}catch(t){return console.error("Location search failed:",t),[]}}async getLocationSuggestions(e){return(await this.searchLocations(e)).map(r=>r.display_name)}isLocationInKenya(e,t){const r={north:5,south:-4.7,east:41.9,west:33.9};return e>=r.south&&e<=r.north&&t>=r.west&&t<=r.east}getDistance(e,t,r,s){const n=this.deg2rad(r-e),l=this.deg2rad(s-t),u=Math.sin(n/2)*Math.sin(n/2)+Math.cos(this.deg2rad(e))*Math.cos(this.deg2rad(r))*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))}deg2rad(e){return e*(Math.PI/180)}async requestLocationPermission(){if(!this.isSupported)throw new Error("Geolocation is not supported");try{return await this.getCurrentLocation(),!0}catch(e){if(e.type==="permission_denied")return!1;throw e}}async checkLocationPermission(){if(!this.isSupported)return!1;try{return await this.getCurrentLocation(),!0}catch(e){return e.type!=="permission_denied"}}isLocationDetectionSupported(){return this.isSupported||navigator.onLine}}const w=new C;class D{constructor(){this.whatsappNumber="+254743375997",this.businessName="Eastleigh Turf Grass",this.loadConfig()}loadConfig(){try{window.whatsappConfig&&(this.whatsappNumber=window.whatsappConfig.phoneNumber||this.whatsappNumber,this.businessName=window.whatsappConfig.businessName||this.businessName)}catch(e){console.warn("Failed to load WhatsApp config:",e)}}formatCurrency(e){return new Intl.NumberFormat("en-KE",{style:"currency",currency:"KES",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}formatArea(e){return`${e.toLocaleString()} m²`}generateOrderMessage(e,t,r){const{name:s,phone:o,location:n}=e,{items:l}=t,{subtotal:u,discountAmount:c,total:p,appliedCoupon:d,appliedPromotion:y}=r;let i=`🏠 *${this.businessName} - New Order*

`;i+=`👤 *Customer Details:*
`,i+=`Name: ${s}
`,i+=`Phone: ${o}
`,i+=`Location: ${n}

`,i+=`📦 *Order Items:*
`;let v=0;return l.forEach((f,b)=>{const S=f.area||0;v+=S,i+=`${b+1}. ${f.name}
`,i+=`   • Size: ${f.width}m × ${f.length}m = ${this.formatArea(S)}
`,i+=`   • Price: ${this.formatCurrency(f.total)}

`}),i+=`📊 *Order Summary:*
`,i+=`Total Area: ${this.formatArea(v)}
`,i+=`Subtotal: ${this.formatCurrency(u)}
`,c>0&&(i+=`Discount: -${this.formatCurrency(c)}
`,d&&(i+=`Coupon: ${d.code} (${d.value}% off)
`),y&&(i+=`Promotion: ${y.name}
`)),i+=`*Final Total: ${this.formatCurrency(p)}*

`,i+=`📅 Order Date: ${new Date().toLocaleDateString("en-KE")}
`,i+=`🕒 Order Time: ${new Date().toLocaleTimeString("en-KE")}

`,i+="Please confirm this order and provide delivery details. Thank you! 🙏",i}generateSimpleOrderMessage(e,t,r){const{name:s,phone:o,location:n}=e,{items:l}=t,{total:u}=r;let c=`🏠 *${this.businessName}*

`;return c+=`New order from ${s}
`,c+=`Phone: ${o}
`,c+=`Location: ${n}

`,c+=`Items:
`,l.forEach((p,d)=>{c+=`${d+1}. ${p.name} - ${this.formatCurrency(p.total)}
`}),c+=`
Total: ${this.formatCurrency(u)}`,c}generateWhatsAppUrl(e){const t=encodeURIComponent(e);return`https://wa.me/${this.whatsappNumber.replace(/\D/g,"")}?text=${t}`}openWhatsApp(e){const t=this.generateWhatsAppUrl(e);window.open(t,"_blank")}async copyToClipboard(e){try{return await navigator.clipboard.writeText(e),{success:!0,message:"Message copied to clipboard!"}}catch(t){console.error("Failed to copy to clipboard:",t);const r=document.createElement("textarea");r.value=e,document.body.appendChild(r),r.select();try{return document.execCommand("copy"),document.body.removeChild(r),{success:!0,message:"Message copied to clipboard!"}}catch{return document.body.removeChild(r),{success:!1,message:"Failed to copy message"}}}}openWhatsAppWeb(){window.open("https://web.whatsapp.com","_blank")}generateOrderId(){const e=Date.now(),t=Math.floor(Math.random()*1e3);return`ETG-${e}-${t}`}formatOrderForDisplay(e,t,r){const{name:s,phone:o,location:n}=e,{items:l}=t,{subtotal:u,discountAmount:c,total:p}=r;return{customer:{name:s,phone:o,location:n},items:l.map(d=>({name:d.name,size:`${d.width}m × ${d.length}m`,area:this.formatArea(d.area||0),price:this.formatCurrency(d.total)})),summary:{totalArea:this.formatArea(l.reduce((d,y)=>d+(y.area||0),0)),subtotal:this.formatCurrency(u),discount:this.formatCurrency(c),total:this.formatCurrency(p)}}}validateMessageLength(e){return{valid:e.length<=4096,length:e.length,maxLength:4096,remaining:4096-e.length}}truncateMessage(e,t=4e3){if(e.length<=t)return e;const r=e.substring(0,t),s=r.lastIndexOf("."),o=r.lastIndexOf(`
`),n=Math.max(s,o);return n>t*.8?r.substring(0,n+1)+`

[Message truncated due to length]`:r+`

[Message truncated due to length]`}generateMessageTemplate(e,t,r,s){switch(e){case"detailed":return this.generateOrderMessage(t,r,s);case"simple":return this.generateSimpleOrderMessage(t,r,s);case"urgent":return this.generateUrgentMessage(t,r,s);default:return this.generateOrderMessage(t,r,s)}}generateUrgentMessage(e,t,r){return`🚨 *URGENT ORDER* 🚨

${this.generateOrderMessage(e,t,r)}`}getMessagePreview(e,t=200){return e.length<=t?e:e.substring(0,t)+"..."}sanitizeMessage(e){return e.replace(/[<>]/g,"").replace(/\n{3,}/g,`

`).trim()}}const h=new D;class P{constructor(){this.modal=null,this.currentStep=1,this.isInitialized=!1}async init(){if(!this.isInitialized)try{await this.createModal(),this.bindEvents(),this.setupValidation(),this.subscribeToState(),this.isInitialized=!0}catch(e){console.error("Failed to initialize checkout modal:",e)}}async createModal(){try{const e=await fetch("/Eastleigh-Turf-Grass-Clean/partials/checkout-modal.html");if(!e.ok)throw new Error("Failed to load checkout modal template");const t=await e.text();document.body.insertAdjacentHTML("beforeend",t),this.modal=document.getElementById("checkoutModal")}catch(e){throw console.error("Error creating checkout modal:",e),e}}bindEvents(){if(!this.modal)return;const e=this.modal.querySelector("#closeCheckoutModal");e&&e.addEventListener("click",()=>this.close());const t=this.modal.querySelector(".modal-overlay");t&&t.addEventListener("click",()=>this.close()),this.bindFormEvents(),this.bindNavigationEvents(),this.bindDetectEvents(),this.bindWhatsAppEvents(),this.bindKeyboardEvents()}bindFormEvents(){const e=this.modal.querySelector("#customerName"),t=this.modal.querySelector("#customerPhone"),r=this.modal.querySelector("#customerLocation"),s=this.modal.querySelector("#rememberDetails");e&&e.addEventListener("input",o=>{a.updateCustomerData("name",o.target.value)}),t&&(m.setupPhoneFormatting(t),t.addEventListener("input",o=>{a.updateCustomerData("phone",o.target.value)})),r&&r.addEventListener("input",o=>{a.updateCustomerData("location",o.target.value)}),s&&s.addEventListener("change",o=>{a.updateRememberDetails(o.target.checked)})}bindNavigationEvents(){const e=this.modal.querySelector("#nextBtn"),t=this.modal.querySelector("#backBtn"),r=this.modal.querySelector("#sendBtn");e&&e.addEventListener("click",()=>this.nextStep()),t&&t.addEventListener("click",()=>this.previousStep()),r&&r.addEventListener("click",()=>this.sendOrder())}bindDetectEvents(){const e=this.modal.querySelector("#detectPhoneBtn"),t=this.modal.querySelector("#detectLocationBtn");e&&e.addEventListener("click",()=>this.detectPhone()),t&&t.addEventListener("click",()=>this.detectLocation())}bindWhatsAppEvents(){const e=this.modal.querySelector("#copyMessageBtn"),t=this.modal.querySelector("#openWhatsAppWebBtn");e&&e.addEventListener("click",()=>this.copyMessage()),t&&t.addEventListener("click",()=>this.openWhatsAppWeb())}bindKeyboardEvents(){document.addEventListener("keydown",e=>{!this.modal||!this.modal.classList.contains("active")||(e.key==="Escape"?this.close():e.key==="Enter"&&e.ctrlKey&&(e.preventDefault(),this.handleEnterKey()))})}handleEnterKey(){switch(this.currentStep){case 1:this.nextStep();break;case 2:this.nextStep();break;case 3:this.sendOrder();break}}subscribeToState(){a.subscribe(e=>{this.updateUI(e)})}setupValidation(){this.modal.querySelectorAll("input[required]").forEach(t=>{t.addEventListener("blur",()=>{this.validateField(t)}),t.addEventListener("input",()=>{m.clearError(t)})})}validateField(e){const t=e.name,r=e.value;let s;switch(t){case"name":s=m.validateName(r);break;case"phone":s=m.validatePhone(r);break;case"location":s=m.validateLocation(r);break;default:return}s.valid?m.clearError(e):m.showError(e,s.message)}open(){if(!this.modal){console.error("Checkout modal not initialized");return}if(a.getCartData().items.length===0){this.showEmptyCartMessage();return}this.modal.classList.add("active"),this.loadSavedData(),this.updateUI(a.getState());const t=this.modal.querySelector("input");t&&t.focus(),document.body.style.overflow="hidden"}close(){this.modal&&(this.modal.classList.remove("active"),a.reset(),document.body.style.overflow="")}showEmptyCartMessage(){alert("Please add items to your cart before checkout.")}nextStep(){this.currentStep===1&&!this.validateStep1()||a.nextStep()&&(this.currentStep=a.getState().currentStep,this.updateStepDisplay())}previousStep(){a.previousStep()&&(this.currentStep=a.getState().currentStep,this.updateStepDisplay())}validateStep1(){const e=a.getState().customerData,t=m.validateForm(e);return t.valid?(Object.keys(t.formattedData).forEach(r=>{a.updateCustomerData(r,t.formattedData[r])}),!0):(Object.keys(t.errors).forEach(r=>{const s=this.modal.querySelector(`[name="${r}"]`);s&&m.showError(s,t.errors[r])}),!1)}updateUI(e){this.currentStep=e.currentStep,this.updateFormFields(e.customerData),this.updateStepDisplay(),this.updateButtonStates(),this.updateStepContent()}updateFormFields(e){const t=this.modal.querySelector("#customerName"),r=this.modal.querySelector("#customerPhone"),s=this.modal.querySelector("#customerLocation");t&&(t.value=e.name||""),r&&(r.value=e.phone||""),s&&(s.value=e.location||"")}updateStepDisplay(){const e=this.modal.querySelectorAll(".step"),t=this.modal.querySelectorAll(".step-line");e.forEach((r,s)=>{const o=s+1;r.classList.remove("active","completed"),o===this.currentStep?r.classList.add("active"):o<this.currentStep&&r.classList.add("completed")}),t.forEach((r,s)=>{const o=s+1;r.classList.remove("active"),o<this.currentStep&&r.classList.add("active")})}updateButtonStates(){const e=this.modal.querySelector("#nextBtn"),t=this.modal.querySelector("#backBtn"),r=this.modal.querySelector("#sendBtn");e&&(e.style.display=this.currentStep<3?"flex":"none",e.innerHTML=this.currentStep===1?'Review Order <i class="fas fa-arrow-right"></i>':'Send Order <i class="fas fa-arrow-right"></i>'),t&&(t.style.display=this.currentStep>1?"flex":"none"),r&&(r.style.display=this.currentStep===3?"flex":"none")}updateStepContent(){this.modal.querySelectorAll(".checkout-step").forEach((t,r)=>{const s=r+1;if(t.classList.remove("active"),s===this.currentStep)switch(t.classList.add("active"),s){case 2:this.loadOrderSummary();break;case 3:this.loadWhatsAppConfirmation();break}})}loadOrderSummary(){const e=a.getState(),t=a.getCartData(),r=a.getDiscountData(),s=this.modal.querySelector("#summaryName"),o=this.modal.querySelector("#summaryPhone"),n=this.modal.querySelector("#summaryLocation");if(s&&(s.textContent=e.customerData.name),o){const l=e.customerData.phone,u=l?l.replace(/^\+/,""):"",c=u?`+254 ${u}`:"";o.textContent=c}n&&(n.textContent=e.customerData.location),this.updateOrderItems(t.items),this.updateOrderSummary(t,r)}updateOrderItems(e){const t=this.modal.querySelector("#orderItemsList");t&&(t.innerHTML="",e.forEach(r=>{const s=document.createElement("div");s.className="order-item",s.innerHTML=`
                <img src="${r.image}" alt="${r.name}" class="order-item-image">
                <div class="order-item-details">
                    <div class="order-item-name">${r.name}</div>
                    <div class="order-item-specs">${r.width}m × ${r.length}m = ${h.formatArea(r.area||0)}</div>
                    <div class="order-item-price">${h.formatCurrency(r.total)}</div>
                </div>
            `,t.appendChild(s)}))}updateOrderSummary(e,t){const r=e.items.reduce((u,c)=>u+(c.area||0),0),s=this.modal.querySelector("#totalArea"),o=this.modal.querySelector("#summarySubtotal"),n=this.modal.querySelector("#summaryDiscount"),l=this.modal.querySelector("#summaryTotal");s&&(s.textContent=h.formatArea(r)),o&&(o.textContent=h.formatCurrency(t.subtotal)),n&&(n.textContent=`-${h.formatCurrency(t.discountAmount)}`),l&&(l.textContent=h.formatCurrency(t.total))}loadWhatsAppConfirmation(){const e=a.getState(),t=a.getCartData(),r=a.getDiscountData(),s=h.generateOrderMessage(e.customerData,t,r),o=this.modal.querySelector("#messagePreview");o&&(o.textContent=s)}async detectPhone(){const e=this.modal.querySelector("#detectPhoneBtn"),t=this.modal.querySelector("#customerPhone");if(!(!e||!t))try{if(this.setDetectButtonLoading(e,"Detecting..."),!m.isPhoneDetectionSupported()){this.showInfoMessage("Phone detection is not available in this browser. Please enter your number manually.");return}const r=await m.detectPhone();r.success?(t.value=r.phone,a.updateCustomerData("phone",r.phone),this.showSuccessMessage(r.message),this.setDetectButtonSuccess(e,"Detected")):(this.showErrorMessage(r.error),this.setDetectButtonNormal(e,"Detect"))}catch(r){console.error("Phone detection error:",r),this.showErrorMessage("Phone detection failed. Please enter your number manually."),this.setDetectButtonNormal(e,"Detect")}}async detectLocation(){const e=this.modal.querySelector("#detectLocationBtn"),t=this.modal.querySelector("#customerLocation");if(!(!e||!t))try{if(this.setDetectButtonLoading(e,"Detecting..."),!w.isLocationDetectionSupported()){this.showInfoMessage("Location detection is not available. Please enter your address manually.");return}const r=await w.detectLocation();r.success?(t.value=r.address,a.updateCustomerData("location",r.address),r.isApproximate?this.showInfoMessage(r.message):this.showSuccessMessage(r.message),this.setDetectButtonSuccess(e,"Detected")):(this.showErrorMessage(r.error),this.setDetectButtonNormal(e,"Detect"))}catch(r){console.error("Location detection error:",r),this.showErrorMessage("Location detection failed. Please enter your address manually."),this.setDetectButtonNormal(e,"Detect")}}setDetectButtonLoading(e,t){e.disabled=!0,e.classList.add("loading"),e.innerHTML=`<i class="fas fa-spinner fa-spin"></i> ${t}`}setDetectButtonSuccess(e,t){e.disabled=!1,e.classList.remove("loading"),e.classList.add("success"),e.innerHTML=`<i class="fas fa-check"></i> ${t}`,setTimeout(()=>{this.setDetectButtonNormal(e,"Detect")},3e3)}setDetectButtonNormal(e,t){e.disabled=!1,e.classList.remove("loading","success"),e.innerHTML=t}sendOrder(){const e=a.getState(),t=a.getCartData(),r=a.getDiscountData(),s=h.generateOrderMessage(e.customerData,t,r);h.openWhatsApp(s),this.close()}async copyMessage(){const e=a.getState(),t=a.getCartData(),r=a.getDiscountData(),s=h.generateOrderMessage(e.customerData,t,r),o=await h.copyToClipboard(s);o.success?this.showSuccessMessage(o.message):this.showErrorMessage(o.message)}openWhatsAppWeb(){h.openWhatsAppWeb()}loadSavedData(){const e=a.getState();this.updateFormFields(e.customerData)}showSuccessMessage(e){this.showToast("Success",e,"success")}showErrorMessage(e){this.showToast("Error",e,"error")}showInfoMessage(e){this.showToast("Info",e,"info")}showToast(e,t,r="info"){window.showToast?window.showToast(e,t,r):(console.log(`${r.toUpperCase()}: ${e} - ${t}`),r==="error"&&alert(`${e}: ${t}`))}}const M=new P;export{M as checkoutModal};
